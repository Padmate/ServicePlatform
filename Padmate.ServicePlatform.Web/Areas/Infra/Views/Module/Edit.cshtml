@{
    Layout = null;
    var _type = Request["type"];
    var _moduleId = Request["moduleId"];
    M_Module module = (M_Module)ViewData["module"];
}
@using Padmate.ServicePlatform.Utility;
@using Padmate.ServicePlatform.Models;


<!--#region修改-->
<div class="close-modal" data-dismiss="modal">
    <i class="fa fa-3x fa-close"></i>
</div>
<div class="container">

    <h3 class="customer-h3 text-center">修 改</h3>
    <hr />
    <div class="form-horizontal">
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">URL唯一标识：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbModuleUrlId" value="@module.ModuleURLId" style="width:40%" placeholder="只能是字母、数字或 - 组成" />
                <input class="btn btn-default" id="btnGenerateNewUrlId" type="button" style="width:9%" value="自动生成" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">一级标题：</label>
            </div>
            <div class="col-md-10">
                <input class="inputS" id="tbTitle" placeholder="一级标题" value="@module.Title" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">二级标题：</label>
            </div>
            <div class="col-md-10">
                <input class="inputS" id="tbSubTitle" placeholder="二级标题" value="@module.SubTitle" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">模块描述：</label>
            </div>
            <div class="col-md-10">
                <textarea class="textareaS" id="taDescription">@module.Description</textarea>
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">顺序：</label>
            </div>
            <div class="col-md-10">
                <input class="inputS" id="tbSequence" placeholder="顺序" value="@module.Sequence" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">模块图片：</label>
            </div>
            <div class="col-md-10">
                <div id="uploadThumbnailsImage">选择图片</div>
                <span class="customer-content-sm" id="status"></span>
            </div>
            <div class="col-lg-4 col-md-6 col-md-offset-2" style="margin-top:10px;">

                @{
                    var imgSrc = "../img/small_model.jpg";
                    if (module.Image != null)
                    {
                        imgSrc = module.Image.VirtualPath;
                    }
                    <img class="image-smallsize" id="showUploadImage" src="@imgSrc" />
                }
            </div>

        </div>
        
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">是否链接：</label>
            </div>
            <div class="col-md-10">
                <input type="radio" value="true" name="IsHref" /><label>是</label>
                <input type="radio" value="false" checked="checked" name="IsHref" style="margin-left:50px;" /><label>否</label>

            </div>
        </div>
        <div class="form-group" id="divModuleHref" style="display:none;">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">模块链接：</label>
            </div>
            <div class="col-md-10">
                <input class="inputS" id="tbHref" placeholder="模块链接" value="@module.Href" />
            </div>
        </div>

        <div class="form-group" id="divModuleContent">
            <div class="col-md-12">
                <div class="checkbox">
                    <textarea id="tbEditContent" name="tbEditContent">@module.Content</textarea>
                </div>
            </div>
            <div style="clear:both"></div>
        </div>
    </div>

</div>
<div class="modal-footer">
    <button type="button" class="btn btn-lg btn-info"
            data-dismiss="modal">
        退 出
    </button>
    <button type="button" class="btn btn-lg btn-danger" onclick="SaveEdit()">
        保 存
    </button>
</div>
<!--#endregion 修改-->

<link rel="stylesheet" type="text/css" href="~/Scripts/webuploader/webuploader.css">
<script src="~/Scripts/webuploader/webuploader.js"></script>
<script src="~/Scripts/webuploader/customer-image-webuploader.js"></script>
<script>

    var editor = CKEDITOR.instances["tbEditContent"];
    if (editor) { editor.destroy(true); }
    CKEDITOR.replace("tbEditContent", {
        enterMode: CKEDITOR.ENTER_BR
    });
    CKFinder.setupCKEditor(null, '@Url.Content("~/ckfinder/")');

    var uploader;

    $(function () {

        //模块是否链接事件
        $("[name='IsHref']").change(function () {
            ChangeHrefRadio();
        });

        //如果模块是链接，则选中链接选项
        var isHref = '@module.IsHref';
        if (isHref.toLowerCase() == "true") {
            $("input[type=radio][value=true]").attr("checked", 'checked');
            ChangeHrefRadio();
        }

        uploader = $("#uploadThumbnailsImage").InitImageWebUploader({
            url: "/Infra/Module/UploadThumbnailsImage",
            size: 1,
            multiple: false,
            autoupload: false,
            thumbid: "#showUploadImage",
            singleupload: true
        }, function () {
            //图片上传成功后关闭对话框，刷新表格
            CloseEditScreen();
            //刷新
            RefreshTable();
            $("body").hideLoading();
        });

    })

    function UploadImage(moduleId) {

        uploader.options.formData.moduleId = moduleId;
        uploader.upload();
    }

    

    function ChangeHrefRadio() {
        var isHref = $("input[name='IsHref']:checked").val();

        $("#divModuleHref").toggle();
        $("#divModuleContent").toggle();

        if (isHref == "true") {
            //如果是链接，则隐藏并且清空内容编辑框,显示Href输入框
            //CKEDITOR.instances.Content.setData("");
            CKEDITOR.instances["tbEditContent"].setData("");

        } else {
            //如果不是链接，则隐藏并且清空Href输入框,显示内容编辑框
            $("#Href").val(" ");
        }
    }

    //修改或新增保存
    function SaveEdit() {

        $("body").showLoading();
        var saveObj = ConstructSaveObj();
        var jsonParam = JSON.stringify(saveObj);
        $.ajax({
            type: "POST",
            url: "/Infra/Module/SaveEdit",
            dataType: "json",
            data: jsonParam,
            async: false,   //同步
            success: function (message) {

                if (message.Success) {
                    //上传图片
                    UploadImage(message.ReturnId);

                } else {
                    $("body").hideLoading();
                    layer.alert(message.Content, {
                        skin: 'layui-layer-molv' //样式类名
                      , closeBtn: 0
                    });
                    return;
                }
            }
        });
    }

    function InitGenerateModuleUrlIdEvent() {
        $("#btnGenerateNewUrlId").click(function () {

            $.ajax({
                type: "POST",
                url: "/Infra/Module/GenerateNewURLId",
                dataType: "json",
                async: false,   //同步
                success: function (message) {

                    if (message.Success) {

                        $("#tbModuleUrlId").val(message.ReturnStrId);

                    } else {
                        layer.alert(message.Content, {
                            skin: 'layui-layer-molv' //样式类名
                          , closeBtn: 0
                        });
                        return;
                    }
                }
            });
        });
    }


    //构造保存对象
    function ConstructSaveObj() {
        var editor = CKEDITOR.instances["tbEditContent"];
        var obj = {
            Id: '@_moduleId',
            Title: $("#tbTitle").val(),
            SubTitle: $("#tbSubTitle").val(),
            Description: $("#taDescription").val(),
            ModuleUrlId: $("#tbModuleUrlId").val(),
            Sequence: $("#tbSequence").val(),
            IsHref: $("input[name='IsHref']:checked").val(),
            IsHref: $("input[name='IsHref']:checked").val(),
            Href: $("#tbHref").val(),
            Content: editor.getData(),
            Type: '@_type'

        };
        return obj;
    }
</script>