@using Padmate.ServicePlatform.Models;
@using Padmate.ServicePlatform.Utility;
@{
    Layout = null;
    var user = (M_User)ViewData["UserInfo"];

    var userType = string.Empty;
    if (!string.IsNullOrEmpty(user.UserType))
    {
        userType = Common.Dic_UserTypes.ContainsKey(user.UserType) ?
        Common.Dic_UserTypes[user.UserType] : user.UserType;
    }

    //项目内容
    var project = (M_IntelInnovationProjectApply)ViewData["project"];
}

<link rel="stylesheet" type="text/css" href="~/Scripts/webuploader/webuploader.css">
<script src="~/Scripts/webuploader/webuploader.js"></script>

<style>
   

    .attachment-delete {
        float: right;
    }

    .projectArea {
        margin-bottom: 100px;
    }

    #thelist {
        margin-bottom: 10px;
    }
    #thelist a{
        margin:5px;
        text-decoration:underline
    }

     .projectStatus {
        color: red;
        padding-bottom: 20px;
    }
   
</style>

<div class="container">
    <div class="row projectArea">
        <div class="col-sm-8 col-md-8">
            <div class="form-horizontal">
                <div class="col-md-offset-3 col-md-9">
                    <!--项目状态-->
                    <div class="customer-content-md projectStatus">

                        <label id="AuditStatusMsg">

                        </label>
                        <label id="AuditRemarkMsg"></label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">项目名称：</label>
                    </div>
                    <div class="col-md-9">
                        <input class="input-large-full" id="tbName" placeholder="项目名称" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-3 text-right">
                        <label class="customer-content-sm">所属组别：</label>
                    </div>
                    <div class="col-md-9">
                        <label class="customer-content-sm">@userType</label>
                    </div>

                </div>
                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">是否有样机：</label>
                    </div>
                    <div class="col-md-9">

                        <input type="radio" value="true" name="HasExample" id="hasExampleTrue" />
                        <label for="hasExampleTrue">是</label>

                        <input type="radio" value="false" name="HasExample" id="hasExampleFalse" style="margin-left:50px;" />
                        <label for="hasExampleFalse">否</label>


                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">上传商业计划书：</label>
                    </div>
                    <div class="col-md-9">
                        <div id="uploadFiles">上传附件</div>

                        <div id="thelist" class="uploader-list"></div>

                    </div>

                </div>
                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">项目简介：</label>
                    </div>
                    <div class="col-md-9">
                        <textarea id="taDescription" class="textarea-large-full"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">创新点：</label>
                    </div>
                    <div class="col-md-9">
                        <textarea id="taInnovationPoint" class="textarea-large-full"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">联系人：</label>
                    </div>
                    <div class="col-md-9">
                        <input class="input-large-full" id="tbContact" placeholder="联系人" />
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-3 control-label">
                        <label class="customer-content-sm">联系电话：</label>
                    </div>
                    <div class="col-md-9">
                        <input class="input-large-full" id="tbContactPhone" placeholder="联系电话" />
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-12 text-right">
                        <a class="btn-gelatine btn-gelatine-success" href="javaScript:void(0);" id="btnSave">保 存</a>
                        <a class="btn-gelatine btn-gelatine-info" href="javaScript:void(0);" id="btnApply">提交申请</a>

                    </div>
                </div>

            </div>
        </div>

        <div class="col-sm-6 col-md-5 col-md-offset-1">


        </div>

    </div>
</div>

<script>

    var dicAuditStatus = $.parseJSON('@Html.Raw(ViewData["AuditStatus"])');

    $(function () {
        InitButton();
        InitFileUploader();
        var userId = '@user.Id';
        LoadProjectByUserId(userId);
    });


    function DicAuditStatus(key) {
        var result = key;
        for (var i = 0; i < dicAuditStatus.length; i++) {
            if (key == dicAuditStatus[i].Key) {
                result = dicAuditStatus[i].Value;
            }
        }
        return result;
    }

    //根据用户ID加载项目数据
    function LoadProjectByUserId(userId) {

        $.ajax({
            type: "POST",
            url: "/ProjectApply/IntelInnovationProjectApply/LoadProjectDataByUserId",
            dataType: "json",
            data: { UserId: userId },
            async: false,   //同步
            success: function (message) {
                if (message.Success) {

                    //先清空
                    $("#tbName").val("");
                    $("#taDescription").val("");
                    $("#taInnovationPoint").val("");
                    $("#tbContact").val("");
                    $("#tbContactPhone").val("");
                    $("#AuditStatusMsg").html("");

                    var project = $.parseJSON(message.Content);
                    //赋值
                    $("#tbName").val(project.Name);
                    $("#taDescription").val(project.Description);
                    $("#taInnovationPoint").val(project.InnovationPoint);
                    $("#tbContact").val(project.Contact);
                    $("#tbContactPhone").val(project.ContactPhone);
                    CheckHasExample(project.HasExample);
                    RefreshFileQueueList(project.Attachments);

                    if(project.LatestQue != null)
                    {
                        $("#AuditStatusMsg").html("审核状态："+DicAuditStatus(project.LatestQue.AuditStatus));
                    }
                    

                } else {


                    layer.alert(message.Content, {
                        skin: 'layui-layer-molv' //样式类名
                      , closeBtn: 0
                    });
                    return;
                }

            }
        });

    }

    function LoadProjectAttachmentsByProjectId(projectId) {
        var result = null;
        $.ajax({
            type: "POST",
            url: "/ProjectApply/IntelInnovationProjectApply/LoadProjectAttachmentDataByProjectId",
            dataType: "json",
            data: { ProjectId: projectId },
            async: false,   //同步
            success: function (data) {

                result = data;
            }
        });
        return result;

    }

    function CheckHasExample(value) {

        if (value != null && value) {
            $("input[name='HasExample'][value=true]").attr('checked', true);

        } else {
            $("input[name='HasExample'][value=false]").attr('checked', true);

        }
    }

    //当前点击按钮是不是“提交申请”
    var _isApplyButton = false;
    var _buttonSaveSuccessMsg;
    function InitButton() {
        $("#btnApply").click(function () {

            _isApplyButton = true;
            _buttonSaveSuccessMsg = "申请成功";
            SaveAndApply();
        });
        $("#btnSave").click(function () {
            _isApplyButton = false;
            _buttonSaveSuccessMsg = "保存成功";
            SaveAndApply();
        });
    }

    ///保存和提交
    //buttonType:save/apply
    function SaveAndApply() {
        var url = "/ProjectApply/IntelInnovationProjectApply/SaveEdit";
        if (_isApplyButton) {
            url = "/ProjectApply/IntelInnovationProjectApply/Apply";
        }


        var obj = {
            Id: '@project.Id',
            Name: $("#tbName").val(),
            Description: $("#taDescription").val(),
            HasExample: $("input[name='HasExample']:checked").val(),
            InnovationPoint: $("#taInnovationPoint").val(),
            Contact: $("#tbContact").val(),
            ContactPhone: $("#tbContactPhone").val()
        };

        $("body").showLoading();

        var jsonParam = JSON.stringify(obj);
        $.ajax({
            type: "POST",
            url: url,
            dataType: "json",
            data: jsonParam,
            async: false,   //同步
            success: function (message) {


                if (message.Success) {
                    //上传文件
                    var files = fileUploader.getFiles("inited");//初始状态
                    if (files.length > 0) {
                        UploadFiles();


                    } else {
                        //如果当前没有文件上传
                        if(_isApplyButton)
                        {
                            $("body").hideLoading();
                            layer.alert(_buttonSaveSuccessMsg, {
                                skin: 'layui-layer-molv' //样式类名
                                , closeBtn: 0
                            }, function () {
                                //如果是提交申请，则直接刷新当前页面
                                window.location.reload();
                            });

                        } else {
                            //重新加载数据
                            LoadProjectByUserId('@user.Id');
                            $("body").hideLoading();
                            layer.alert(_buttonSaveSuccessMsg, {
                                skin: 'layui-layer-molv' //样式类名
                                , closeBtn: 0
                            });
                        }
                    }



                } else {

                    $("body").hideLoading();
                    //tips层
                    layer.alert(message.Content, {
                        skin: 'layui-layer-molv' //样式类名
                      , closeBtn: 0
                    });
                }

            }
        });
    }

    var fileUploader;
    function InitFileUploader() {

        var GUID = WebUploader.Base.guid();//一个GUID
        // 初始化Web Uploader
        fileUploader = WebUploader.create({
            auto: false,   // 选完文件后，是否自动上传。
            swf: '../Scripts/webuploader/Uploader.swf',
            server: '/ProjectApply/IntelInnovationProjectApply/ChunkedUploadAttachment',
            duplicate: false, //可重复上传同一文件
            pick: '#uploadFiles',  // 选择文件的按钮。可选。内部根据当前运行是创建，可能是input元素，也可能是flash.
            compress: false, //图片不压缩
            multiple: true,
            fileSingleSizeLimit: 200 * 1024 * 1024, // 单个文件最大不能超过200 M
            chunked: true,//开始分片上传
            chunkSize: 2 * 1024 * 1024,//每一片的大小为2M
            formData: {
                guid: GUID //自定义参数
            },
            accept: {
                title: 'file',
                extensions: 'txt,doc,docx,xls,xlsx,ppt,pptx,pdf,rtf,rar,zip,bmp,gif,jpg,jpeg,png',
                mimeTypes: 'image/*,text/plain,application/msword,application/x-xls,application/vnd.ms-excel,application/x-ppt,application/vnd.ms-powerpoint,application/pdf,application/rtf,application/x-rtf,application/zip,application/x-rar-compressed'
            }


        });

        fileUploader.on('beforeFileQueued', function (file) {


        });

        fileUploader.on('fileQueued', function (file) {
            AddFileQueueData(file);

        });

        fileUploader.on('uploadStart', function (file) {

        });

        fileUploader.on('uploadProgress', function (file, percentage) {


        });


        fileUploader.on('error', function (handler) {

            //隐藏遮罩
            $("body").hideLoading();
            if (handler == "Q_TYPE_DENIED") {
                alert("文件类型不支持");
            }

            if (handler == "Q_EXCEED_NUM_LIMIT") {
                alert("超出最大张数");
            }
            if (handler == "F_DUPLICATE") {
                alert("不能重复上传同一文件");
            }
            if (handler == "F_EXCEED_SIZE") {

                layer.alert("文件大小不能超过200M", {
                    skin: 'layui-layer-molv' //样式类名
                       , closeBtn: 0
                });
            }
        });


        // 文件上传成功，给item添加成功class, 用样式标记上传成功。
        fileUploader.on('uploadSuccess', function (file, response) {


            if (response.Success == false || response.Success == "false") {
                layer.alert(response.Content, {
                    skin: 'layui-layer-molv' //样式类名
                      , closeBtn: 0
                });
            } else {
                ;
                var obj = {
                    IntelInnovationProjectApplyId: '@project.Id',
                    guid: GUID,
                    fileName: file.name,
                    extension: file.ext
                };

                $.post('/ProjectApply/IntelInnovationProjectApply/MergeFile', obj, function (data) {

                    var cc = fileUploader.getFiles("queued");
                    var dd = fileUploader.getFiles("progress");
                    //上传完成
                    var completeFiles = fileUploader.getFiles("complete");
                    var allFiles = fileUploader.getFiles();
                    //当最后一文件上传完之后再执行刷新操作
                    if(completeFiles.length == allFiles.length)
                    {
                        //上传成功
                        if (_isApplyButton) {
                            $("body").hideLoading();
                            //如果当前是提交申请，则直接刷新当前页面
                            layer.alert(_buttonSaveSuccessMsg, {
                                skin: 'layui-layer-molv' //样式类名
                                    , closeBtn: 0
                            }, function () {
                                window.location.reload();
                            });

                        } else {
                            $("body").hideLoading();
                            LoadProjectByUserId('@user.Id');

                            //删除队列中当前上传完的文件
                            fileUploader.removeFile(file, true);

                            layer.alert(_buttonSaveSuccessMsg, {
                                skin: 'layui-layer-molv' //样式类名
                                    , closeBtn: 0
                            });
                        }
                    }

                    
                });

            }

        });

        fileUploader.on('uploadFinished', function () {
            //无论有没有要上传的文件都会进入
            $("body").hideLoading();


        });


        // 完成上传完了，成功或者失败，先删除进度条。
        fileUploader.on('uploadComplete', function (file) {

        });
    }

    function UploadFiles() {

        //fileUploader.options.formData.articleId = articleId;
        fileUploader.upload();
    }

    //添加文件队列
    function AddFileQueueData(file) {

        var dynamicHtml = "";

        dynamicHtml += '<div id="' + file.id + '">';
        dynamicHtml += '<a class="customer-content-sm" href="javaScript:void(0)">' + file.name + '</a>';
        dynamicHtml += '<a class="customer-content-sm attachment-delete" href="javaScript:void(0)" onclick="RemoveFileQueueData(' + file.id + ')">';
        dynamicHtml += '<i class="fa fa-remove"></i>删除';
        dynamicHtml += '</a>';
        dynamicHtml += '<div class="clearfix"></div>';
        dynamicHtml += '</div>';

        $("#thelist").append(dynamicHtml);
    }

    function RemoveFileQueueData(div) {

        //删除文件显示信息
        $("#" + div.id).remove();


        var file = fileUploader.getFile(div.id);
        //删除队列中的文件
        fileUploader.removeFile(file, true);

    }



    //清空文件上传队列
    function EmptyFileQueue() {
        var files = fileUploader.getFiles();
        for (var i = 0; i < files.length; i++) {
            //删除队列中的文件
            fileUploader.removeFile(files[i], true);
        }

    }

    //重新刷新附件表格
    function RefreshFileQueueList(attachments) {

        //先清空
        $("#thelist").html("");

        var dynamicHtml = "";
        if (attachments != null && attachments.length > 0) {
            for (var i = 0; i < attachments.length; i++) {
                dynamicHtml += '<div>';
                dynamicHtml += '<a class="customer-content-sm" href="' + attachments[i].VirtualPath + '">' + attachments[i].Name + '</a>';
                dynamicHtml += '<a class="customer-content-sm attachment-delete" href="javaScript:void(0)" onclick="DeleteFile(' + attachments[i].Id + ')">';
                dynamicHtml += '<i class="fa fa-remove"></i>删除';
                dynamicHtml += '</a>';
                dynamicHtml += '<div class="clearfix"></div>';
                dynamicHtml += '</div>';
            }
        }


        $("#thelist").html(dynamicHtml);

    }

    function DeleteFile(attachmentId) {

        $.ajax({
            type: "POST",
            url: "/ProjectApply/IntelInnovationProjectApply/DeleteAttachment",
            dataType: "json",
            data: { Id: attachmentId },
            async: false,   //同步
            success: function (message) {
                if (message.Success == false || message.Success == "false") {
                    layer.alert(message.Content, {
                        skin: 'layui-layer-molv' //样式类名
                       , closeBtn: 0
                    });
                    return;
                } else {
                    //重新加载
                    var attachments = LoadProjectAttachmentsByProjectId('@project.Id');
                    RefreshFileQueueList(attachments);
                }

            }
        });
    }




</script>